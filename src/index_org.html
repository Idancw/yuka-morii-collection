<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuka Morii Collector</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Auth Modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .auth-box h2 {
            margin-top: 0;
            color: #667eea;
        }

        .auth-box input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .auth-box button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .auth-box button:hover {
            background: #5568d3;
        }

        .auth-box button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-toggle a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            margin: 0;
            color: #667eea;
            font-size: 1.8em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-email {
            color: #666;
            font-weight: 500;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #ffd700;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e6c200;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .stats {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-weight: bold;
            color: #666;
            margin-right: 10px;
            margin-bottom: 8px;
            display: inline-block;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #667eea;
            color: white;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .era-btn {
            padding: 8px 16px;
            border: 2px solid #764ba2;
            background: white;
            color: #764ba2;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .era-btn:hover {
            background: #764ba2;
            color: white;
        }

        .era-btn.active {
            background: #764ba2;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .grid.binder-view {
            grid-template-columns: repeat(3, 1fr);
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
        }

        .card-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f5f5f5;
        }

        .binder-view .card-image {
            height: 280px;
        }

        .card-name {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .card-set {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }

        .card-number {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 10px;
        }

        .status-box {
            width: 40px;
            height: 40px;
            margin: 10px auto;
            border: 3px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 24px;
            user-select: none;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .status-box:hover {
            transform: scale(1.1);
        }

        .status-no {
            background: #fff;
            color: transparent;
            border-color: #ddd;
        }

        .status-ordered {
            background: #ffd700;
            color: #333;
            border-color: #ffd700;
        }

        .status-yes {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .owned-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .badge-ordered {
            background: #ffd700;
            color: #333;
        }

        .badge-yes {
            background: #4CAF50;
            color: white;
        }

        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .share-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .share-box h2 {
            margin-top: 0;
            color: #667eea;
        }

        .share-link {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            margin: 15px 0;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }

            .grid.binder-view {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .header h1 {
                font-size: 1.4em;
            }
        }
    </style>
</head>
<body>

<div id="loading" class="loading">Loading...</div>

<!-- Auth Modal -->
<div id="auth-modal" class="auth-modal hidden">
    <div class="auth-box">
        <h2 id="auth-title">Sign In</h2>
        <div id="auth-error" style="color: red; margin-bottom: 10px; display: none;"></div>

        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-password" placeholder="Password">

        <button id="auth-submit">Sign In</button>

        <div class="auth-toggle">
            <span id="auth-toggle-text">Don't have an account? </span>
            <a id="auth-toggle-link">Sign Up</a>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="share-modal" class="share-modal hidden">
    <div class="share-box">
        <h2>Share Your Collection</h2>
        <p>Share this link to let others view your collection:</p>
        <div class="share-link" id="share-link"></div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="copyShareLink()">Copy Link</button>
            <button class="btn btn-secondary" onclick="closeShareModal()">Close</button>
        </div>
    </div>
</div>

<div id="app-container" class="container hidden">
    <div class="header">
        <h1>üé¥ Yuka Morii Card Collection</h1>
        <div class="user-info">
            <span class="user-email" id="user-email"></span>
            <button class="btn btn-secondary" onclick="toggleView()">
                <span id="view-toggle-text">Binder View</span>
            </button>
            <button class="btn btn-primary" onclick="shareCollection()" id="share-btn">Share</button>
            <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-item">
            <div class="stat-number" id="total-cards">0</div>
            <div class="stat-label">Total Cards</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="owned-count" style="color: #4CAF50;">0</div>
            <div class="stat-label">Owned</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="ordered-count" style="color: #ffd700;">0</div>
            <div class="stat-label">Ordered</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="needed-count" style="color: #999;">0</div>
            <div class="stat-label">Needed</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="completion-rate" style="color: #667eea;">0%</div>
            <div class="stat-label">Completion</div>
        </div>
    </div>

    <div class="filters">
        <div class="filter-section">
            <span class="filter-label">Status:</span>
            <div class="filter-buttons">
                <button class="filter-btn active" data-status="all" onclick="filterByStatus('all')">All</button>
                <button class="filter-btn" data-status="yes" onclick="filterByStatus('yes')">Owned</button>
                <button class="filter-btn" data-status="ordered" onclick="filterByStatus('ordered')">Ordered</button>
                <button class="filter-btn" data-status="no" onclick="filterByStatus('no')">Needed</button>
            </div>
        </div>
        <div class="filter-section">
            <span class="filter-label">Era:</span>
            <div class="filter-buttons" id="era-buttons">
                <button class="era-btn active" data-era="all" onclick="filterByEra('all')">All Eras</button>
            </div>
        </div>
    </div>

    <div id="card-grid" class="grid"></div>
</div>

<!-- Firebase SDK v9 (Modular) -->
<script type="module">
    import { auth, db } from './src/firebase.js';
    import { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';


    // Global variables
    let currentUser = null;
    let allCards = [];
    let userCollection = {};
    let currentStatusFilter = 'all';
    let currentEraFilter = 'all';
    let isBinderView = false;
    let isViewOnly = false;

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
        document.getElementById('loading').classList.add('hidden');

        const urlParams = new URLSearchParams(window.location.search);
        const sharedUserId = urlParams.get('user');

        if (user) {
            currentUser = user;
            document.getElementById('auth-modal').classList.add('hidden');

            // This replaces your old loadCards call
            allCards = await initializeUserData(user.uid);

            updateStats();
            renderCards();
        } else {
            document.getElementById('auth-modal').classList.remove('hidden');
        }

        if (sharedUserId && !user) {
            // Viewing shared collection without being logged in
            isViewOnly = true;
            currentUser = {uid: sharedUserId, email: 'Shared Collection'};
            document.getElementById('user-email').textContent = 'Viewing Shared Collection';
            document.getElementById('share-btn').style.display = 'none';
            document.querySelector('.btn-danger').style.display = 'none';
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            await loadCards(sharedUserId);
        } else if (user) {
            // User is signed in
            currentUser = user;
            isViewOnly = false;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            await loadCards(user.uid);
        } else {
            // No user signed in, show auth
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }
    });

    // Auth handlers
    let isSignIn = true;

    document.getElementById('auth-toggle-link').onclick = () => {
        isSignIn = !isSignIn;
        document.getElementById('auth-title').textContent = isSignIn ? 'Sign In' : 'Sign Up';
        document.getElementById('auth-submit').textContent = isSignIn ? 'Sign In' : 'Sign Up';
        document.getElementById('auth-toggle-text').textContent = isSignIn ? "Don't have an account? " : "Already have an account? ";
        document.getElementById('auth-toggle-link').textContent = isSignIn ? 'Sign Up' : 'Sign In';
        document.getElementById('auth-error').style.display = 'none';
    };

    document.getElementById('auth-submit').onclick = async () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        const errorDiv = document.getElementById('auth-error');
        const submitBtn = document.getElementById('auth-submit');

        errorDiv.style.display = 'none';

        if (!email || !password) {
            errorDiv.textContent = 'Please enter email and password';
            errorDiv.style.display = 'block';
            return;
        }

        if (password.length < 6) {
            errorDiv.textContent = 'Password must be at least 6 characters';
            errorDiv.style.display = 'block';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Loading...';

        try {
            if (isSignIn) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
        } catch (error) {
            let message = 'An error occurred';
            if (error.code === 'auth/email-already-in-use') {
                message = 'Email already in use';
            } else if (error.code === 'auth/invalid-email') {
                message = 'Invalid email address';
            } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                message = 'Invalid email or password';
            } else if (error.code === 'auth/weak-password') {
                message = 'Password is too weak';
            }
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = isSignIn ? 'Sign In' : 'Sign Up';
        }
    };

    // Sign out
    window.signOut = async () => {
        try {
            await firebaseSignOut(auth);
            currentUser = null;
            userCollection = {};
            allCards = [];
        } catch (error) {
            console.error('Sign out error:', error);
            alert('Error signing out');
        }
    };

    async function initializeUserData(userId) {
        const docRef = doc(db, "collections", userId);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
            // 1. The user is new! Fetch the local template
            console.log("No database found for user. Uploading template...");
            const response = await fetch('cards.json');
            const templateCards = await response.json();

            // 2. Save the template to this user's Firebase document
            await setDoc(docRef, {
                cards: templateCards,
                lastUpdated: new Date()
            });

            return templateCards;
        } else {
            // 3. User already has data, return that instead
            return docSnap.data().cards;
        }
    }

    // Load cards
    async function loadCards(userId) {
        try {
            // Load card database
            const response = await fetch('cards.json');
            allCards = await response.json();

            // Load user's collection from Firestore
            const docRef = doc(db, 'collections', userId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                userCollection = docSnap.data();
                allCards.forEach(card => {
                    if (userCollection[card.id]) {
                        card.owned = userCollection[card.id];
                    } else {
                        card.owned = 'no';
                    }
                });
            } else {
                // Initialize with all cards as "no"
                allCards.forEach(card => card.owned = 'no');
            }

            populateEraButtons();
            renderCards();
            updateStats();
        } catch (error) {
            console.error('Error loading cards:', error);
            document.getElementById('card-grid').innerHTML = '<p style="color: white; text-align: center;">Error loading cards</p>';
        }
    }

    function populateEraButtons() {
        const eras = [...new Set(allCards.map(card => card.era).filter(Boolean))].sort();
        const container = document.getElementById('era-buttons');
        container.innerHTML = '<button class="era-btn active" data-era="all" onclick="filterByEra(\'all\')">All Eras</button>';

        eras.forEach(era => {
            const button = document.createElement('button');
            button.className = 'era-btn';
            button.setAttribute('data-era', era);
            button.textContent = era;
            button.onclick = () => window.filterByEra(era);
            container.appendChild(button);
        });
    }

    function renderCards() {
        const grid = document.getElementById('card-grid');
        grid.innerHTML = '';
        grid.className = isBinderView ? 'grid binder-view' : 'grid';

        const filteredCards = allCards.filter(card => {
            const statusMatch = currentStatusFilter === 'all' || card.owned === currentStatusFilter;
            const eraMatch = currentEraFilter === 'all' || card.era === currentEraFilter;
            return statusMatch && eraMatch;
        });

        if (filteredCards.length === 0) {
            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">No cards match the current filters.</p>';
            return;
        }

        filteredCards.forEach((card) => {
            const cardEl = document.createElement('div');
            cardEl.className = 'card';

            let displayImage = card.imageUrl;
            if (!displayImage && card.url && card.url.includes('serebii.net')) {
                displayImage = card.url.replace('.shtml', '.jpg');
            }
            if (!displayImage) {
                displayImage = 'https://via.placeholder.com/180x250?text=No+Image';
            }

            const symbol = card.owned === 'yes' ? '‚úì' : (card.owned === 'ordered' ? '‚è≥' : '');
            const statusClass = `status-${card.owned}`;

            let badge = '';
            if (card.owned === 'ordered') {
                badge = '<div class="owned-badge badge-ordered">ORDERED</div>';
            } else if (card.owned === 'yes') {
                badge = '<div class="owned-badge badge-yes">OWNED</div>';
            }

            const statusBox = isViewOnly ? '' : `
                    <div class="status-box ${statusClass}" data-card-id="${card.id}">
                        ${symbol}
                    </div>
                `;

            cardEl.innerHTML = `
                    ${badge}
                    <img src="${displayImage}" alt="${card.name}" class="card-image"
                         onerror="this.src='https://via.placeholder.com/180x250?text=No+Image'">
                    ${!isBinderView ? `
                        <div class="card-name">${card.name}</div>
                        <div class="card-set">${card.set || 'Unknown Set'}</div>
                        <div class="card-number">#${card.number || '???'}</div>
                    ` : ''}
                    ${statusBox}
                `;

            if (!isViewOnly) {
                const statusBoxEl = cardEl.querySelector('.status-box');
                if (statusBoxEl) {
                    statusBoxEl.onclick = () => toggleState(card.id);
                }
            }

            grid.appendChild(cardEl);
        });
    }

    async function toggleState(cardId) {
        if (isViewOnly) return;

        const card = allCards.find(c => c.id === cardId);
        if (!card) return;

        if (card.owned === 'no') {
            card.owned = 'ordered';
        } else if (card.owned === 'ordered') {
            card.owned = 'yes';
        } else {
            card.owned = 'no';
        }

        userCollection[card.id] = card.owned;
        await saveCollection();
        renderCards();
        updateStats();
    }

    async function saveCollection() {
        try {
            const docRef = doc(db, 'collections', currentUser.uid);
            await setDoc(docRef, userCollection, {merge: true});
        } catch (error) {
            console.error('Error saving collection:', error);
            alert('Error saving. Please try again.');
        }
    }

    function updateStats() {
        const total = allCards.length;
        const owned = allCards.filter(c => c.owned === 'yes').length;
        const ordered = allCards.filter(c => c.owned === 'ordered').length;
        const needed = allCards.filter(c => c.owned === 'no').length;
        const completion = total > 0 ? Math.round((owned / total) * 100) : 0;

        document.getElementById('total-cards').textContent = total;
        document.getElementById('owned-count').textContent = owned;
        document.getElementById('ordered-count').textContent = ordered;
        document.getElementById('needed-count').textContent = needed;
        document.getElementById('completion-rate').textContent = completion + '%';
    }

    window.filterByStatus = (status) => {
        currentStatusFilter = status;
        document.querySelectorAll('[data-status]').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-status="${status}"]`).classList.add('active');
        renderCards();
    };

    window.filterByEra = (era) => {
        currentEraFilter = era;
        document.querySelectorAll('[data-era]').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-era="${era}"]`).classList.add('active');
        renderCards();
    };

    window.toggleView = () => {
        isBinderView = !isBinderView;
        document.getElementById('view-toggle-text').textContent = isBinderView ? 'Grid View' : 'Binder View';
        renderCards();
    };

    window.shareCollection = () => {
        const shareUrl = window.location.origin + window.location.pathname + '?user=' + currentUser.uid;
        document.getElementById('share-link').textContent = shareUrl;
        document.getElementById('share-modal').classList.remove('hidden');
    };

    window.closeShareModal = () => {
        document.getElementById('share-modal').classList.add('hidden');
    };

    window.copyShareLink = () => {
        const link = document.getElementById('share-link').textContent;
        navigator.clipboard.writeText(link).then(() => {
            alert('Link copied to clipboard!');
        });
    };
</script>
</body>
</html>